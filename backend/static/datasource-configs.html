<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Datasource Configs</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><path fill='%233B82F6' d='M466.5 83.7l-192-80a48.15 48.15 0 0 0-36.9 0l-192 80C27.7 91.1 16 108.6 16 128c0 198.5 114.5 335.7 221.5 380.3 11.8 4.9 25.1 4.9 36.9 0C360.1 472.6 496 349.3 496 128c0-19.4-11.7-36.9-29.5-44.3zM256.1 446.3l-.1-381 175.9 73.3c-3.3 151.4-82.1 261.1-175.8 307.7z'/></svg>">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #0f172a;
      --secondary: #3b82f6;
      --secondary-dark: #2563eb;
      --accent: #8b5cf6;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --warning-dark: #d97706;
      --bg: #f8fafc;
      --bg-secondary: #ffffff;
      --border: #e2e8f0;
      --border-light: #f1f5f9;
      --text-primary: #0f172a;
      --text-secondary: #64748b;
      --text-tertiary: #94a3b8;
      --radius: 10px;
      --radius-lg: 14px;
      --shadow-sm: 0 2px 8px rgba(15, 23, 42, 0.06);
      --shadow-lg: 0 8px 24px rgba(15, 23, 42, 0.12);
    }

    body {
      font-family:
        "Inter",
        -apple-system,
        BlinkMacSystemFont,
        "Segoe UI",
        sans-serif;
      background: var(--bg);
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
    }

    .sidebar {
      width: 260px;
      height: 100vh;
      background: var(--primary);
      padding: 32px 24px;
      position: fixed;
      left: 0;
      top: 0;
      border-right: 1px solid rgba(255, 255, 255, 0.05);
      display: flex;
      flex-direction: column;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 14px;
      font-size: 1.5rem;
      color: white;
      font-weight: 700;
      margin-bottom: 40px;
      letter-spacing: -0.02em;
    }

    .logo i {
      font-size: 1.6rem;
      color: var(--secondary);
      background: rgba(59, 130, 246, 0.15);
      width: 42px;
      height: 42px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
    }

    .nav-menu {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .nav-link {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 16px;
      text-decoration: none;
      color: rgba(255, 255, 255, 0.7);
      border-radius: var(--radius);
      font-size: 0.94rem;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .nav-link i {
      font-size: 1.1rem;
      width: 20px;
      text-align: center;
    }

    .nav-link:hover {
      background: rgba(255, 255, 255, 0.08);
      color: white;
      transform: translateX(2px);
    }

    .nav-link.active {
      background: linear-gradient(135deg,
          var(--secondary) 0%,
          var(--secondary-dark) 100%);
      color: white;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .main-content {
      margin-left: 260px;
      min-height: 100vh;
    }

    .topbar {
      background: var(--bg-secondary);
      padding: 24px 40px;
      border-bottom: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .topbar-title {
      font-size: 1.75rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 14px;
      letter-spacing: -0.02em;
    }

    .topbar-title i {
      font-size: 1.5rem;
      color: var(--secondary);
      background: rgba(59, 130, 246, 0.1);
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius);
    }

    .add-btn {
      padding: 11px 20px;
      background: linear-gradient(135deg,
          var(--secondary) 0%,
          var(--secondary-dark) 100%);
      color: white;
      border-radius: var(--radius);
      font-size: 0.94rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
      border: none;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.25);
      transition: all 0.2s ease;
    }

    .add-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.35);
    }

    .content-area {
      padding: 36px 40px;
      max-width: 1600px;
    }

    .filter-section {
      background: white;
      padding: 24px 32px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      margin-bottom: 24px;
      display: flex;
      gap: 20px;
      align-items: end;
    }

    .filter-group {
      flex: 1;
      position: relative;
    }

    .filter-label {
      display: block;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 10px;
    }

    .filter-input {
      width: 100%;
      padding: 11px 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.94rem;
      font-family: inherit;
      color: var(--text-primary);
      transition: all 0.2s ease;
      background: var(--bg-secondary);
    }

    .filter-input:focus {
      outline: none;
      border-color: var(--secondary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      background: white;
    }

    .search-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      max-height: 250px;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
      z-index: 1000;
      margin-top: 4px;
      display: none;
    }

    .search-dropdown.show {
      display: block;
    }

    .search-option {
      padding: 12px 14px;
      cursor: pointer;
      border-bottom: 1px solid var(--border-light);
      transition: all 0.2s ease;
    }

    .search-option:hover {
      background: var(--bg);
    }

    .search-option-name {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 2px;
    }

    .search-option-code {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .card {
      background: white;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
    }

    .card-header {
      padding: 24px 32px;
      border-bottom: 1px solid var(--border-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(to bottom, #fafbfc 0%, #ffffff 100%);
    }

    .card-title {
      font-size: 1.15rem;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -0.01em;
    }

    .stats-badge {
      background: var(--bg);
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-secondary);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    thead {
      border-bottom: 2px solid var(--border);
    }

    tbody tr {
      border-bottom: 1px solid var(--border-light);
    }

    th {
      background: #fafbfc;
      padding: 18px 16px;
      text-align: center;
      font-weight: 700;
      color: var(--text-secondary);
      font-size: 0.82rem;
      text-transform: uppercase;
      border-bottom: none;
    }

    th:nth-child(1) {
      width: 20%;
    }

    th:nth-child(2) {
      width: 20%;
    }

    th:nth-child(3) {
      width: 25%;
    }

    th:nth-child(4) {
      width: 11%;
    }

    th:nth-child(5) {
      width: 24%;
    }

    td {
      padding: 28px 16px;
      border-bottom: none;
      font-size: 0.94rem;
      word-wrap: break-word;
      overflow-wrap: break-word;
      hyphens: auto;
      vertical-align: middle;
    }

    tr:hover {
      background: #f8fafc;
      box-shadow: inset 3px 0 0 var(--secondary);
    }

    .config-name {
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .protocol-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(139, 92, 246, 0.1);
      color: var(--accent);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 600;
      white-space: normal;
      word-break: break-word;
    }

    .driver-badge {
      background: rgba(59, 130, 246, 0.1);
      color: var(--secondary);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 600;
      white-space: normal;
      word-break: break-word;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .status-active {
      background: rgba(16, 163, 117, 0.1);
      color: var(--success);
    }

    .status-inactive {
      background: rgba(148, 163, 184, 0.15);
      color: var(--text-secondary);
    }

    .actions {
      display: inline-flex;
      gap: 4px;
      justify-content: center;
      flex-wrap: nowrap;
      align-items: center;
      margin: 6px 0;
    }

    .action-btn {
      padding: 6px 10px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      transition: all 0.2s ease;
      background: white;
      color: var(--text-secondary);
      font-size: 0.8rem;
      font-weight: 600;
      white-space: nowrap;
      flex-shrink: 0;
      line-height: 1;
    }

    .action-btn i {
      font-size: 0.8rem;
      margin-right: 4px;
    }

    .action-btn:hover {
      background: var(--secondary);
      color: white;
      border-color: var(--secondary);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(59, 130, 246, 0.25);
    }

    .action-btn.delete:hover {
      background: var(--danger);
      border-color: var(--danger);
      box-shadow: 0 4px 8px rgba(239, 68, 68, 0.25);
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(4px);
      display: none;
      justify-content: center;
      align-items: center;
      padding: 20px;
      z-index: 1000;
      animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 0;
      border-radius: var(--radius-lg);
      width: 100%;
      max-width: 600px;
      box-shadow: var(--shadow-lg);
      animation: slideUp 0.3s ease;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 2px solid var(--border-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(to bottom, #fafbfc 0%, #ffffff 100%);
      flex-shrink: 0;
    }

    .modal-header h3 {
      font-size: 1.35rem;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -0.01em;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .modal-header h3 i {
      width: 40px;
      height: 40px;
      background: rgba(59, 130, 246, 0.1);
      color: var(--secondary);
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
    }

    .close-btn {
      width: 36px;
      height: 36px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: white;
      color: var(--text-secondary);
      font-size: 1.3rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .close-btn:hover {
      background: var(--danger);
      color: white;
      border-color: var(--danger);
    }

    .modal-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .form-input,
    .form-textarea,
    select.form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.9rem;
      font-family: inherit;
      color: var(--text-primary);
      transition: all 0.2s ease;
      background: var(--bg-secondary);
    }

    .form-input:focus,
    .form-textarea:focus,
    select.form-input:focus {
      outline: none;
      border-color: var(--secondary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      background: white;
    }

    .form-textarea {
      resize: vertical;
      min-height: 80px;
    }

    select.form-input {
      cursor: pointer;
    }

    .toggle-container {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 8px 0;
    }

    .toggle {
      width: 52px;
      height: 28px;
      background: #cbd5e1;
      border-radius: 14px;
      cursor: pointer;
      position: relative;
      transition: all 0.3s ease;
    }

    .toggle.active {
      background: var(--success);
    }

    .toggle::after {
      content: "";
      width: 22px;
      height: 22px;
      background: white;
      border-radius: 50%;
      position: absolute;
      top: 3px;
      left: 3px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .toggle.active::after {
      transform: translateX(24px);
    }

    .toggle-label {
      font-weight: 600;
      color: var(--text-primary);
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 2px solid var(--border-light);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      background: var(--bg);
      flex-shrink: 0;
    }

    .btn {
      padding: 10px 18px;
      border-radius: var(--radius);
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.875rem;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg,
          var(--secondary) 0%,
          var(--secondary-dark) 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.25);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.35);
    }

    .btn-secondary {
      background: white;
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--bg);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.25);
    }

    .btn-danger:hover {
      background: #dc2626;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.35);
    }

    .delete-modal-content {
      max-width: 480px;
    }

    .modal-icon {
      width: 64px;
      height: 64px;
      background: rgba(239, 68, 68, 0.1);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
    }

    .modal-icon i {
      font-size: 1.8rem;
      color: var(--danger);
    }

    .modal-title {
      font-size: 1.35rem;
      font-weight: 700;
      margin-bottom: 12px;
      color: var(--text-primary);
      letter-spacing: -0.01em;
      text-align: center;
    }

    .modal-text {
      color: var(--text-secondary);
      font-size: 0.95rem;
      margin-bottom: 24px;
      line-height: 1.6;
      text-align: center;
    }

    .empty-state {
      padding: 80px 20px;
      text-align: center;
      color: var(--text-secondary);
    }

    .empty-icon {
      width: 120px;
      height: 120px;
      background: linear-gradient(135deg,
          rgba(59, 130, 246, 0.08) 0%,
          rgba(139, 92, 246, 0.08) 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
    }

    .empty-icon i {
      font-size: 3.5rem;
      color: var(--secondary);
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 10px;
      color: var(--text-primary);
    }

    .empty-state p {
      font-size: 0.95rem;
      color: var(--text-tertiary);
    }

    .loading {
      padding: 60px;
      text-align: center;
      color: var(--text-secondary);
    }

    .loading i {
      font-size: 2rem;
      margin-bottom: 16px;
      color: var(--secondary);
    }

    .loading-text {
      font-size: 0.95rem;
      font-weight: 500;
    }

    /* NOTIFICATION POPUP */
    .notification-popup {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 23, 42, 0.5);
      backdrop-filter: blur(8px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      animation: fadeIn 0.2s ease;
    }

    .notification-popup.active {
      display: flex;
    }

    .notification-content {
      background: white;
      border-radius: var(--radius-lg);
      box-shadow: 0 20px 60px rgba(15, 23, 42, 0.3);
      max-width: 500px;
      width: 90%;
      padding: 0;
      animation: slideUpBounce 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      display: flex;
      gap: 20px;
      position: relative;
      overflow: hidden;
    }

    @keyframes slideUpBounce {
      0% {
        opacity: 0;
        transform: translateY(50px) scale(0.9);
      }

      100% {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .notification-icon {
      background: linear-gradient(135deg,
          var(--secondary) 0%,
          var(--secondary-dark) 100%);
      padding: 32px 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .notification-icon i {
      font-size: 2.5rem;
      color: white;
    }

    .notification-body {
      padding: 28px 20px 28px 0;
      flex: 1;
    }

    .notification-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 10px;
      letter-spacing: -0.01em;
    }

    .notification-message {
      font-size: 0.95rem;
      color: var(--text-secondary);
      line-height: 1.6;
      margin-bottom: 0;
    }

    .notification-link-container {
      margin-top: 18px;
      padding-top: 18px;
      border-top: 1px solid var(--border-light);
    }

    .notification-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      background: linear-gradient(135deg,
          var(--secondary) 0%,
          var(--secondary-dark) 100%);
      color: white;
      text-decoration: none;
      border-radius: var(--radius);
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.25);
    }

    .notification-link:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.35);
      gap: 12px;
    }

    .notification-close {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 32px;
      height: 32px;
      border: none;
      background: rgba(15, 23, 42, 0.05);
      color: var(--text-secondary);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      transition: all 0.2s ease;
    }

    .notification-close:hover {
      background: var(--danger);
      color: white;
      transform: rotate(90deg);
    }

    #cancel:hover {
      background: var(--danger);
      color: white;
      border-color: var(--danger);
    }

    /* EXPANDABLE CONFIG ROW */
    .expanded-row {
      display: none;
    }

    .expanded-row.show {
      display: table-row;
    }

    .expanded-content {
      padding: 24px 32px;
      background: linear-gradient(to bottom, #f8fafc 0%, #ffffff 100%);
      border-top: 2px solid var(--border);
    }

    .expanded-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }

    .expanded-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .expanded-field-label {
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .expanded-field-value {
      font-size: 0.94rem;
      color: var(--text-primary);
      font-weight: 500;
      padding: 10px 12px;
      background: white;
      border-radius: var(--radius);
      border: 1px solid var(--border-light);
    }

    .expanded-field-value.null-value {
      color: var(--text-tertiary);
      font-style: italic;
    }

    /* Ultra-compact row hint (reusable) */
    .table-note {
      margin: 6px 24px;
      /* minimal vertical space */
      padding: 4px 8px;

      font-size: 0.78rem;
      font-weight: 500;
      color: var(--text-tertiary);

      background: transparent;
      border-left: 2px solid var(--secondary);
    }
  </style>
  <link rel="stylesheet" href="responsive.css" />
</head>

<body>
  <aside class="sidebar">
    <div class="logo">
      <i class="fas fa-shield-alt"></i>
      <span>FlowEngine</span>
    </div>
    <nav class="nav-menu">
      <a href="index.html" class="nav-link"><i class="fas fa-home"></i>Dashboard</a>
      <a href="datasources.html" class="nav-link"><i class="fas fa-database"></i>Datasources</a>
      <a href="datasource-configs.html" class="nav-link active"><i class="fas fa-cog"></i>Datasource Configs</a>
      <a href="intents.html" class="nav-link"><i class="fas fa-bullseye"></i>Intents</a>
      <a href="intent-policies.html" class="nav-link"><i class="fas fa-sliders-h"></i>Intent Policies</a>
      <a href="rules.html" class="nav-link"><i class="fas fa-check-double"></i>Validation Rules</a>
    </nav>
  </aside>

  <main class="main-content">
    <div class="topbar">
      <h1 class="topbar-title">
        <i class="fas fa-cog"></i>Datasource Configs
      </h1>
      <button class="add-btn" onclick="openModal()">
        <i class="fas fa-plus-circle"></i>Add Config
      </button>
    </div>

    <div class="content-area">
      <div class="filter-section">
        <div class="filter-group">
          <label class="filter-label">Search Configuration</label>
          <input type="text" class="filter-input" id="configSearch"
            placeholder="Type to search configs or type 'all' for all configs..." autocomplete="off" />
          <div id="searchDropdown" class="search-dropdown"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">Configuration Details</div>
          <div class="stats-badge" id="statsBadge">0 configs</div>
        </div>
        <div class="table-note">
          Click a row to view full datasource-config details
        </div>
        <div id="loadingState" class="loading" style="display: none">
          <i class="fas fa-spinner fa-spin"></i>
          <div class="loading-text">Loading configs...</div>
        </div>

        <div id="configsContainer"></div>

        <div id="emptyState" class="empty-state" style="display: none">
          <div class="empty-icon">
            <i class="fas fa-cog"></i>
          </div>
          <h3>No Datasource Configs Found</h3>
          <p>Get started by adding your first configuration.</p>
        </div>
      </div>
    </div>
  </main>

  <!-- ADD / EDIT CONFIG MODAL -->
  <div class="modal" id="modalOverlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">
          <i class="fas fa-cog"></i>
          <span id="modalTitleText">Add Config</span>
        </h3>
        <button class="close-btn" onclick="closeModal()">Ã—</button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="configId" />

        <div class="form-group" id="datasourceSearchGroup">
          <label class="form-label">Select Datasource *</label>
          <input class="form-input" id="datasourceSearch" placeholder="Type to search datasources without configs..."
            autocomplete="off" />
          <div id="datasourceDropdown" style="position: relative; display: none">
            <div id="datasourceList" style="
                  position: absolute;
                  top: 0;
                  left: 0;
                  right: 0;
                  background: white;
                  border: 1px solid var(--border);
                  border-radius: var(--radius);
                  max-height: 200px;
                  overflow-y: auto;
                  box-shadow: var(--shadow-lg);
                  z-index: 1000;
                "></div>
          </div>
          <input type="hidden" id="selectedDatasourceId" />
        </div>

        <div class="form-group">
          <label class="form-label">Name *</label>
          <input class="form-input" id="configName" placeholder="e.g., SERVICENOW_ITSM_PROD" />
        </div>

        <div class="form-group">
          <label class="form-label">Protocol *</label>
          <select class="form-input" id="configProtocol">
            <option value="">Select protocol...</option>
            <option value="sql">SQL</option>
            <option value="rest">REST</option>
            <option value="graphql">GraphQL</option>
            <option value="file">File</option>
            <option value="stream">Stream</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Driver Family *</label>
          <input class="form-input" id="configDriver" placeholder="e.g., postgres, cdata, servicenow" />
        </div>

        <div class="form-group">
          <label class="form-label">Base URL</label>
          <input class="form-input" id="configBaseUrl" placeholder="e.g., https://api.servicenow.com" />
        </div>

        <div class="form-group">
          <label class="form-label">Auth Type</label>
          <select class="form-input" id="configAuthType">
            <option value="">Select auth type...</option>
            <option value="oauth2">OAuth 2.0</option>
            <option value="apikey">API Key</option>
            <option value="basic">Basic Auth</option>
            <option value="none">None</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Auth Config (JSON)</label>
          <textarea class="form-textarea" id="configAuthConfig" placeholder='{"client_id":"...", "token_url":"..."}'
            style="font-family: monospace"></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Connection JSON</label>
          <textarea class="form-textarea" id="configConnectionJson" placeholder='{"host":"...", "port":5432}'
            style="font-family: monospace"></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Metadata Reference</label>
          <input class="form-input" id="configMetadataRef" placeholder="e.g., https://api.example.com/openapi.json" />
        </div>
        <div class="form-group">
          <label class="form-label">Router Base URL</label>
          <input class="form-input" id="configRouterBaseUrl" placeholder="e.g., https://router.example.com/api" />
        </div>
        <div class="form-group">
          <label class="form-label">Status</label>
          <div class="toggle-container">
            <div id="configIsActive" class="toggle active" onclick="toggleActive()"></div>
            <span class="toggle-label" id="activeLabel">Active</span>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()" id="cancel">
          <i class="fas fa-times"></i>
          Cancel
        </button>
        <button class="btn btn-primary" onclick="saveConfig()">
          <i class="fas fa-check"></i>
          Save Config
        </button>
      </div>
    </div>
  </div>

  <!-- DELETE CONFIG MODAL -->
  <div class="modal" id="deleteOverlay">
    <div class="modal-content delete-modal-content">
      <div class="modal-body" style="padding: 32px 24px; text-align: center">
        <div class="modal-icon">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h3 class="modal-title">Delete Config</h3>
        <p class="modal-text">
          Are you sure you want to delete this config? This action cannot be
          undone.
        </p>
        <input type="hidden" id="deleteConfigId" />
      </div>

      <div class="modal-footer" style="border-top: none; justify-content: center">
        <button class="btn btn-secondary" onclick="closeDeleteModal()" id="cancel">
          Cancel
        </button>
        <button class="btn btn-danger" onclick="confirmDelete()">
          <i class="fas fa-trash"></i>
          Delete Config
        </button>
      </div>
    </div>
  </div>

  <!-- NOTIFICATION POPUP -->
  <div class="notification-popup" id="notificationPopup">
    <div class="notification-content">
      <div class="notification-icon">
        <i class="fas fa-info-circle"></i>
      </div>
      <div class="notification-body">
        <h4 class="notification-title" id="notificationTitle">
          Notification
        </h4>
        <p class="notification-message" id="notificationMessage">
          This is a notification message.
        </p>
        <div class="notification-link-container" id="notificationLinkContainer" style="display: none">
          <a href="#" class="notification-link" id="notificationLink">
            <span id="notificationLinkText">View details</span>
            <i class="fas fa-arrow-right"></i>
          </a>
        </div>
      </div>
      <button class="notification-close" onclick="closeNotification()">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>

  <script>
    // Check tenant session
    const tenantId = sessionStorage.getItem("tenant_id");
    if (!tenantId) {
      window.location.href = "tenant-login.html";
    }
    const API = window.location.origin;
    let configs = [];
    let datasourcesWithoutConfigs = [];
    let searchFilter = null;

    // ==================== NOTIFICATION FUNCTIONS ====================
    function showNotification(
      type,
      title,
      message,
      actionLabel = null,
      actionUrl = null,
    ) {
      const titleEl = document.getElementById("notificationTitle");
      const messageEl = document.getElementById("notificationMessage");
      const linkContainer = document.getElementById(
        "notificationLinkContainer",
      );
      const link = document.getElementById("notificationLink");
      const linkTextEl = document.getElementById("notificationLinkText");
      const popup = document.getElementById("notificationPopup");
      const iconWrapper = document.querySelector(".notification-icon");
      const iconEl = iconWrapper.querySelector("i");

      titleEl.textContent = title;
      messageEl.textContent = message;

      if (actionLabel && actionUrl) {
        linkTextEl.textContent = actionLabel;
        link.href = actionUrl;
        linkContainer.style.display = "block";
      } else {
        linkContainer.style.display = "none";
      }

      iconWrapper.style.background =
        "linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%)";
      iconEl.className = "fas fa-info-circle";

      if (type === "success") {
        iconWrapper.style.background =
          "linear-gradient(135deg, var(--success) 0%, #059669 100%)";
        iconEl.className = "fas fa-check-circle";
      } else if (type === "error") {
        iconWrapper.style.background =
          "linear-gradient(135deg, var(--danger) 0%, #b91c1c 100%)";
        iconEl.className = "fas fa-times-circle";
      } else if (type === "warning") {
        iconWrapper.style.background =
          "linear-gradient(135deg, var(--warning) 0%, #d97706 100%)";
        iconEl.className = "fas fa-exclamation-triangle";
      } else {
        iconWrapper.style.background =
          "linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%)";
        iconEl.className = "fas fa-info-circle";
      }

      popup.classList.add("active");

      if (!actionLabel && !actionUrl) {
        setTimeout(closeNotification, 6000);
      }
    }

    function closeNotification() {
      document.getElementById("notificationPopup").classList.remove("active");
    }

    // ==================== SEARCH FUNCTIONALITY ====================
    function selectSearchConfig(configId) {
      searchFilter = configId;

      const searchInput = document.getElementById("configSearch");
      const searchDropdown = document.getElementById("searchDropdown");

      if (configId === null) {
        searchInput.value = "All Configs";
      } else {
        const config = configs.find((c) => c.config_id === configId);
        if (config) {
          searchInput.value = config.name;
        }
      }

      searchDropdown.classList.remove("show");
      renderConfigs();
    }

    document.addEventListener("DOMContentLoaded", function () {
      document
        .getElementById("notificationPopup")
        .addEventListener("click", function (e) {
          if (e.target === this) closeNotification();
        });

      const searchInput = document.getElementById("configSearch");
      const searchDropdown = document.getElementById("searchDropdown");

      if (searchInput && searchDropdown) {
        searchInput.addEventListener("input", function () {
          const searchTerm = this.value.toLowerCase().trim();

          if (!searchTerm) {
            searchDropdown.classList.remove("show");
            searchFilter = null;
            renderConfigs();
            return;
          }

          const showAllOption =
            "all".includes(searchTerm) || "all configs".includes(searchTerm);

          const filtered = configs.filter(
            (c) =>
              c.name.toLowerCase().includes(searchTerm) ||
              c.protocol.toLowerCase().includes(searchTerm) ||
              c.driver_family.toLowerCase().includes(searchTerm),
          );

          if (!showAllOption && filtered.length === 0) {
            searchDropdown.innerHTML =
              '<div style="padding: 10px 12px; color: var(--text-secondary); text-align: center;">No matching configs found</div>';
            searchDropdown.classList.add("show");
            return;
          }

          let html = "";

          if (showAllOption) {
            html += `
							<div class="search-option" onclick="selectSearchConfig(null)">
							  <div class="search-option-name">All Configs</div>
							  <div class="search-option-code">Show all configurations</div>
							</div>
						  `;
          }

          filtered.forEach((c) => {
            html += `
							<div class="search-option" onclick="selectSearchConfig(${c.config_id})">
							  <div class="search-option-name">${escapeHtml(c.name)}</div>
							  <div class="search-option-code">Protocol: ${escapeHtml(c.protocol)} | Driver: ${escapeHtml(c.driver_family)}</div>
							</div>
						  `;
          });

          searchDropdown.innerHTML = html;
          searchDropdown.classList.add("show");
        });

        document.addEventListener("click", function (e) {
          if (
            !searchInput.contains(e.target) &&
            !searchDropdown.contains(e.target)
          ) {
            searchDropdown.classList.remove("show");
          }
        });
      }
    });

    // ==================== DATASOURCE FUNCTIONS ====================
    async function loadDatasourcesWithoutConfigs() {
      try {
        const dsRes = await fetch(`${API}/datasources`, {
          headers: { "X-Tenant-ID": tenantId },
        });

        const allDatasources = await dsRes.json();

        const configNames = configs.map((c) => c.name);
        datasourcesWithoutConfigs = allDatasources.filter(
          (ds) => !configNames.includes(ds.connection_key),
        );
      } catch (err) {
        console.error("Failed to load datasources:", err);
      }
    }

    document.addEventListener("DOMContentLoaded", function () {
      const datasourceSearchInput =
        document.getElementById("datasourceSearch");
      const datasourceDropdown =
        document.getElementById("datasourceDropdown");
      const datasourceDropdownList =
        document.getElementById("datasourceList");

      if (
        datasourceSearchInput &&
        datasourceDropdown &&
        datasourceDropdownList
      ) {
        datasourceSearchInput.addEventListener("input", function () {
          const searchTerm = this.value.toLowerCase().trim();

          document.getElementById("selectedDatasourceId").value = "";
          document.getElementById("configName").value = "";
          document.getElementById("configDriver").value = "";
          datasourceSearchInput.style.borderColor = "";
          datasourceSearchInput.style.background = "";

          if (!searchTerm) {
            datasourceDropdown.style.display = "none";
            return;
          }

          const filtered = datasourcesWithoutConfigs.filter(
            (ds) =>
              ds.name.toLowerCase().includes(searchTerm) ||
              ds.datasource_type.toLowerCase().includes(searchTerm),
          );

          if (filtered.length === 0) {
            datasourceDropdownList.innerHTML =
              '<div style="padding: 10px 12px; color: var(--text-secondary); text-align: center;">No datasources without configs found</div>';
            datasourceDropdown.style.display = "block";
            return;
          }

          datasourceDropdownList.innerHTML = filtered
            .map(
              (ds) => `
						  <div onclick="selectDatasource(${ds.datasource_id})" style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid var(--border-light); transition: background 0.2s;" onmouseover="this.style.background='var(--bg)'" onmouseout="this.style.background='white'">
							<div style="font-weight: 600; color: var(--text-primary);">${escapeHtml(ds.name)}</div>
							<div style="font-size: 0.85rem; color: var(--text-secondary);">Type: ${escapeHtml(ds.datasource_type)} | Key: ${escapeHtml(ds.connection_key)}</div>
						  </div>
						`,
            )
            .join("");

          datasourceDropdown.style.display = "block";
        });

        document.addEventListener("click", function (e) {
          if (
            !datasourceSearchInput.contains(e.target) &&
            !datasourceDropdown.contains(e.target)
          ) {
            datasourceDropdown.style.display = "none";
          }
        });
      }

      loadData();
    });

    function selectDatasource(datasourceId) {
      const datasource = datasourcesWithoutConfigs.find(
        (ds) => ds.datasource_id === datasourceId,
      );
      if (!datasource) return;

      document.getElementById("datasourceSearch").value = datasource.name;
      document.getElementById("selectedDatasourceId").value =
        datasource.datasource_id;
      document.getElementById("configName").value = datasource.connection_key;

      document.getElementById("configName").readOnly = true;
      document.getElementById("configDriver").value =
        datasource.datasource_type || "";
      document.getElementById("configDriver").readOnly = false;

      document.getElementById("datasourceSearch").style.borderColor =
        "var(--success)";
      document.getElementById("datasourceSearch").style.background =
        "rgba(16, 185, 129, 0.05)";

      document.getElementById("datasourceDropdown").style.display = "none";
    }

    async function loadData() {
      try {
        document.getElementById("loadingState").style.display = "block";
        document.getElementById("configsContainer").innerHTML = "";
        document.getElementById("emptyState").style.display = "none";

        const res = await fetch(`${API}/datasource-configs`, {
          headers: { "X-Tenant-ID": tenantId },
        });
        configs = await res.json();

        document.getElementById("loadingState").style.display = "none";

        renderConfigs();
      } catch (err) {
        console.error("Failed to load configs:", err);
        document.getElementById("loadingState").innerHTML =
          '<i class="fas fa-exclamation-circle"></i><div class="loading-text">Failed to load configs</div>';
      }
    }

    function updateStatsBadge(count) {
      const badge = document.getElementById("statsBadge");
      badge.textContent = `${count} ${count === 1 ? "config" : "configs"}`;
    }

    function renderConfigs() {
      let displayConfigs = configs;

      if (searchFilter !== null && searchFilter !== undefined) {
        displayConfigs = configs.filter(c => c.config_id === searchFilter);
      }

      updateStatsBadge(displayConfigs.length);

      if (!displayConfigs.length) {
        document.getElementById("emptyState").style.display = "block";
        document.getElementById("configsContainer").innerHTML = "";
        return;
      }

      document.getElementById("emptyState").style.display = "none";

      const container = document.getElementById("configsContainer");
      container.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Protocol</th>
          <th>Driver</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        ${displayConfigs.map(cfg => {
        const statusClass = cfg.is_active ? "status-active" : "status-inactive";
        const statusIcon = cfg.is_active
          ? '<i class="fas fa-check-circle"></i>'
          : '<i class="fas fa-times-circle"></i>';
        const statusText = cfg.is_active ? "Active" : "Inactive";

        return `
            <!-- COLLAPSED ROW (5 columns ONLY) -->
            <tr onclick="toggleExpandConfig(${cfg.config_id}, event)">
              <td style="text-align:center;">
                <div class="config-name" style="justify-content:center;">
                  <i class="fas fa-cog" style="color: var(--secondary); font-size: 0.9rem;"></i>
                  ${escapeHtml(cfg.name)}
                </div>
              </td>

              <td style="text-align:center;">
                <span class="protocol-badge">
                  ${escapeHtml(cfg.protocol.toUpperCase())}
                </span>
              </td>

              <td style="text-align:center;">
                <span class="driver-badge">
                  ${escapeHtml(cfg.driver_family)}
                </span>
              </td>

              <td style="text-align:center;">
                <span class="status-badge ${statusClass}">
                  ${statusIcon} ${statusText}
                </span>
              </td>

              <td style="text-align:center;">
                <div class="actions">
                  <button class="action-btn" onclick="editConfig(${cfg.config_id})">
                    <i class="fas fa-pen"></i> Edit
                  </button>
                  <button class="action-btn delete" onclick="promptDelete(${cfg.config_id})">
                    <i class="fas fa-trash"></i> Delete
                  </button>
                </div>
              </td>
            </tr>

            <!-- EXPANDED ROW (ONLY REQUIRED FIELDS) -->
            <tr class="expanded-row" id="expanded-${cfg.config_id}">
              <td colspan="5">
                <div class="expanded-content">
                  <div class="expanded-grid">

                    <div class="expanded-field">
                      <div class="expanded-field-label">Config ID</div>
                      <div class="expanded-field-value">${formatFieldValue(cfg.config_id)}</div>
                    </div>

                    <div class="expanded-field">
                      <div class="expanded-field-label">Name</div>
                      <div class="expanded-field-value">${formatFieldValue(cfg.name)}</div>
                    </div>

                    <div class="expanded-field">
                      <div class="expanded-field-label">Protocol</div>
                      <div class="expanded-field-value">${formatFieldValue(cfg.protocol)}</div>
                    </div>

                    <div class="expanded-field">
                      <div class="expanded-field-label">Driver Family</div>
                      <div class="expanded-field-value">${formatFieldValue(cfg.driver_family)}</div>
                    </div>

                    <div class="expanded-field">
                      <div class="expanded-field-label">Base URL</div>
                      <div class="expanded-field-value">${formatFieldValue(cfg.base_url)}</div>
                    </div>

                    <div class="expanded-field">
                      <div class="expanded-field-label">Auth Type</div>
                      <div class="expanded-field-value">${formatFieldValue(cfg.auth_type)}</div>
                    </div>

                    <div class="expanded-field">
                      <div class="expanded-field-label">Metadata Reference</div>
                      <div class="expanded-field-value">
                        ${formatFieldValue(cfg.metadata_reference)}
                      </div>
                    </div>

                    <div class="expanded-field">
                      <div class="expanded-field-label">Router Base URL</div>
                      <div class="expanded-field-value">
                        ${formatFieldValue(cfg.router_base_url)}
                      </div>
                    </div>

                    <div class="expanded-field">
                      <div class="expanded-field-label">Is Active</div>
                      <div class="expanded-field-value">
                        ${cfg.is_active ? "Yes" : "No"}
                      </div>
                    </div>

                    <div class="expanded-field">
                      <div class="expanded-field-label">Auth Config</div>
                      <div class="expanded-field-value">
                        ${cfg.auth_config
            ? `<pre style="margin:0; white-space:pre-wrap;">${escapeHtml(
              JSON.stringify(cfg.auth_config, null, 2)
            )}</pre>`
            : '<span class="null-value">Not set</span>'
          }
                      </div>
                    </div>

                    <div class="expanded-field">
                      <div class="expanded-field-label">Connection JSON</div>
                      <div class="expanded-field-value">
                        ${cfg.connection_json
            ? `<pre style="margin:0; white-space:pre-wrap;">${escapeHtml(
              JSON.stringify(cfg.connection_json, null, 2)
            )}</pre>`
            : '<span class="null-value">Not set</span>'
          }
                      </div>
                    </div>

                  </div>
                </div>
              </td>
            </tr>
          `;
      }).join("")}
      </tbody>
    </table>
  `;
    }


    function toggleActive() {
      const toggle = document.getElementById("configIsActive");
      const label = document.getElementById("activeLabel");
      toggle.classList.toggle("active");
      label.textContent = toggle.classList.contains("active")
        ? "Active"
        : "Inactive";
    }

    async function openModal() {
      document.getElementById("modalTitleText").textContent = "Add Config";
      document.getElementById("configId").value = "";
      document.getElementById("datasourceSearch").value = "";
      document.getElementById("selectedDatasourceId").value = "";
      document.getElementById("configName").value = "";
      document.getElementById("configName").readOnly = true;
      document.getElementById("configDriver").readOnly = false;
      document.getElementById("configProtocol").value = "";
      document.getElementById("configDriver").value = "";
      document.getElementById("configBaseUrl").value = "";
      document.getElementById("configAuthType").value = "";
      document.getElementById("configAuthConfig").value = "";
      document.getElementById("configConnectionJson").value = "";
      document.getElementById("configMetadataRef").value = "";
      document.getElementById("configRouterBaseUrl").value = "";

      document.getElementById("datasourceSearchGroup").style.display =
        "block";

      const toggle = document.getElementById("configIsActive");
      const label = document.getElementById("activeLabel");
      toggle.classList.add("active");
      label.textContent = "Active";

      await loadDatasourcesWithoutConfigs();

      document.getElementById("modalOverlay").classList.add("active");

      setTimeout(() => {
        const modalBody = document.querySelector("#modalOverlay .modal-body");
        if (modalBody) modalBody.scrollTop = 0;
      }, 0);
    }

    function closeModal() {
      document.getElementById("modalOverlay").classList.remove("active");
    }

    function editConfig(id) {
      const cfg = configs.find((c) => c.config_id === id);
      if (!cfg) {
        showNotification(
          "error",
          "Config Not Found",
          "The requested configuration could not be found. Please refresh the page and try again.",
        );
        return;
      }

      document.getElementById("modalTitleText").textContent = "Edit Config";
      document.getElementById("configId").value = cfg.config_id;

      document.getElementById("datasourceSearchGroup").style.display = "none";
      document.getElementById("configName").readOnly = true;

      document.getElementById("configName").value = cfg.name || "";
      document.getElementById("configProtocol").value = cfg.protocol || "";
      document.getElementById("configDriver").value = cfg.driver_family || "";
      document.getElementById("configBaseUrl").value = cfg.base_url || "";
      document.getElementById("configAuthType").value = cfg.auth_type || "";
      document.getElementById("configAuthConfig").value = cfg.auth_config
        ? JSON.stringify(cfg.auth_config, null, 2)
        : "";
      document.getElementById("configConnectionJson").value =
        cfg.connection_json
          ? JSON.stringify(cfg.connection_json, null, 2)
          : "";
      document.getElementById("configMetadataRef").value =
        cfg.metadata_ref || "";
      document.getElementById("configRouterBaseUrl").value =
        cfg.router_base_url || "";

      const toggle = document.getElementById("configIsActive");
      const label = document.getElementById("activeLabel");
      if (cfg.is_active) {
        toggle.classList.add("active");
        label.textContent = "Active";
      } else {
        toggle.classList.remove("active");
        label.textContent = "Inactive";
      }

      document.getElementById("modalOverlay").classList.add("active");

      setTimeout(() => {
        const modalBody = document.querySelector("#modalOverlay .modal-body");
        if (modalBody) modalBody.scrollTop = 0;
      }, 0);
    }

    async function saveConfig() {
      const id = document.getElementById("configId").value;
      const toggle = document.getElementById("configIsActive");

      if (!id) {
        const selectedDatasourceId = document.getElementById(
          "selectedDatasourceId",
        ).value;
        if (!selectedDatasourceId) {
          showNotification(
            "warning",
            "Datasource Required",
            "Please select a valid datasource from the dropdown list before saving the configuration.",
          );
          document.getElementById("datasourceSearch").focus();
          return;
        }
      }

      let authConfig = null;
      let connectionJson = null;

      try {
        const authConfigStr = document
          .getElementById("configAuthConfig")
          .value.trim();
        if (authConfigStr) authConfig = JSON.parse(authConfigStr);

        const connectionJsonStr = document
          .getElementById("configConnectionJson")
          .value.trim();
        if (connectionJsonStr) connectionJson = JSON.parse(connectionJsonStr);
      } catch (e) {
        showNotification(
          "error",
          "Invalid JSON",
          "The JSON you entered is not valid. Please check the syntax and try again.",
        );
        return;
      }

      const payload = {
        name: document.getElementById("configName").value.trim(),
        protocol: document.getElementById("configProtocol").value.trim(),
        driver_family: document.getElementById("configDriver").value.trim(),
        base_url:
          document.getElementById("configBaseUrl").value.trim() || null,
        auth_type:
          document.getElementById("configAuthType").value.trim() || null,
        auth_config: authConfig,
        connection_json: connectionJson,
        metadata_ref:
          document.getElementById("configMetadataRef").value.trim() || null,
        router_base_url:
          document.getElementById("configRouterBaseUrl").value.trim() || null,
        is_active: toggle.classList.contains("active"),
      };

      if (!payload.name || !payload.protocol || !payload.driver_family) {
        showNotification(
          "warning",
          "Required Fields Missing",
          "Name, Protocol, and Driver Family are all required fields for datasource configuration.",
        );
        return;
      }

      const method = id ? "PUT" : "POST";
      const url = id
        ? `${API}/datasource-configs/${id}`
        : `${API}/datasource-configs`;

      try {
        const res = await fetch(url, {
          method,
          headers: {
            "Content-Type": "application/json",
            "X-Tenant-ID": tenantId,
          },
          body: JSON.stringify(payload),
        });

        if (!res.ok) {
          const err = await res
            .json()
            .catch(() => ({ detail: "Server error" }));
          showNotification(
            "error",
            "Failed to Save Configuration",
            err.detail ||
            "An error occurred while saving the configuration. Please try again.",
          );
          return;
        }

        closeModal();
        showNotification(
          "success",
          "Configuration Saved Successfully",
          `The configuration has been ${id ? "updated" : "created"} successfully.`,
        );
        setTimeout(() => location.reload(), 1500);
      } catch (err) {
        console.error("Save failed:", err);
        showNotification(
          "error",
          "Save Failed",
          err.message ||
          "Failed to save the configuration. Please try again.",
        );
      }
    }

    function promptDelete(id) {
      document.getElementById("deleteConfigId").value = id;
      document.getElementById("deleteOverlay").classList.add("active");
    }

    function closeDeleteModal() {
      document.getElementById("deleteOverlay").classList.remove("active");
    }

    async function confirmDelete() {
      const id = document.getElementById("deleteConfigId").value;
      if (!id) return;

      try {
        const res = await fetch(`${API}/datasource-configs/${id}`, {
          method: "DELETE",
          headers: { "X-Tenant-ID": tenantId },
        });

        if (!res.ok) {
          const err = await res
            .json()
            .catch(() => ({ detail: "Server error" }));
          showNotification(
            "error",
            "Failed to Delete Configuration",
            err.detail ||
            "An error occurred while deleting the configuration. Please try again.",
          );
          closeDeleteModal();
          return;
        }

        closeDeleteModal();
        showNotification(
          "success",
          "Configuration Deleted",
          "The configuration has been deleted successfully.",
        );
        setTimeout(() => location.reload(), 1500);
      } catch (err) {
        console.error("Delete failed:", err);
        showNotification(
          "error",
          "Delete Failed",
          err.message ||
          "Failed to delete the configuration. Please try again.",
        );
      }
    }

    function escapeHtml(str) {
      if (str === null || str === undefined) return "";
      return String(str).replace(
        /[&<>"']/g,
        (m) =>
          ({
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#39;",
          })[m],
      );
    }
    function toggleExpandConfig(configId, event) {
      if (
        event &&
        (event.target.closest(".action-btn") ||
          event.target.closest(".actions"))
      ) {
        return;
      }

      const expandedRow = document.getElementById(`expanded-${configId}`);
      if (expandedRow) {
        expandedRow.classList.toggle("show");
      }
    }

    function formatFieldValue(value) {
      if (value === null || value === undefined || value === "") {
        return '<span class="null-value">Not set</span>';
      }
      if (typeof value === "boolean") {
        return value ? "Yes" : "No";
      }
      return escapeHtml(String(value));
    }
  </script>
  <script src="responsive.js"></script>
</body>

</html>