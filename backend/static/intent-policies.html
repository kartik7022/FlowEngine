<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Intent Policies — FlowEngine</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><path fill='%233B82F6' d='M466.5 83.7l-192-80a48.15 48.15 0 0 0-36.9 0l-192 80C27.7 91.1 16 108.6 16 128c0 198.5 114.5 335.7 221.5 380.3 11.8 4.9 25.1 4.9 36.9 0C360.1 472.6 496 349.3 496 128c0-19.4-11.7-36.9-29.5-44.3zM256.1 446.3l-.1-381 175.9 73.3c-3.3 151.4-82.1 261.1-175.8 307.7z'/></svg>">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #0f172a;
      --primary-light: #1e293b;
      --secondary: #3b82f6;
      --secondary-dark: #2563eb;
      --accent: #8b5cf6;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --warning-dark: #d97706;
      --bg: #f8fafc;
      --bg-secondary: #ffffff;
      --border: #e2e8f0;
      --border-light: #f1f5f9;
      --text-primary: #0f172a;
      --text-secondary: #64748b;
      --text-tertiary: #94a3b8;
      --radius: 10px;
      --radius-lg: 14px;
      --shadow-xs: 0 1px 2px rgba(15, 23, 42, 0.04);
      --shadow-sm: 0 2px 8px rgba(15, 23, 42, 0.06);
      --shadow-md: 0 4px 16px rgba(15, 23, 42, 0.08);
      --shadow-lg: 0 8px 24px rgba(15, 23, 42, 0.12);
    }

    body {
      font-family:
        "Inter",
        -apple-system,
        BlinkMacSystemFont,
        "Segoe UI",
        sans-serif;
      background: var(--bg);
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .sidebar {
      width: 260px;
      height: 100vh;
      background: var(--primary);
      padding: 32px 24px;
      position: fixed;
      left: 0;
      top: 0;
      border-right: 1px solid rgba(255, 255, 255, 0.05);
      display: flex;
      flex-direction: column;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 14px;
      font-size: 1.5rem;
      color: white;
      font-weight: 700;
      margin-bottom: 40px;
      letter-spacing: -0.02em;
    }

    .logo i {
      font-size: 1.6rem;
      color: var(--secondary);
      background: rgba(59, 130, 246, 0.15);
      width: 42px;
      height: 42px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
    }

    .nav-menu {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .nav-link {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 16px;
      text-decoration: none;
      color: rgba(255, 255, 255, 0.7);
      border-radius: var(--radius);
      font-size: 0.94rem;
      font-weight: 500;
      transition: all 0.2s ease;
      position: relative;
    }

    .nav-link i {
      font-size: 1.1rem;
      width: 20px;
      text-align: center;
    }

    .nav-link:hover {
      background: rgba(255, 255, 255, 0.08);
      color: white;
      transform: translateX(2px);
    }

    .nav-link.active {
      background: linear-gradient(135deg,
          var(--secondary) 0%,
          var(--secondary-dark) 100%);
      color: white;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .main-content {
      margin-left: 260px;
      min-height: 100vh;
    }

    .topbar {
      background: var(--bg-secondary);
      padding: 24px 40px;
      border-bottom: 1px solid var(--border);
      box-shadow: var(--shadow-xs);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .topbar-title {
      font-size: 1.75rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 14px;
      letter-spacing: -0.02em;
    }

    .topbar-title i {
      font-size: 1.5rem;
      color: var(--secondary);
      background: rgba(59, 130, 246, 0.1);
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius);
    }

    .add-btn {
      padding: 11px 20px;
      background: linear-gradient(135deg,
          var(--secondary) 0%,
          var(--secondary-dark) 100%);
      color: white;
      border-radius: var(--radius);
      font-size: 0.94rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
      border: none;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.25);
      transition: all 0.2s ease;
    }

    .add-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.35);
    }

    .add-btn:active {
      transform: translateY(0);
    }

    .add-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .content-area {
      padding: 36px 40px;
      max-width: 1600px;
    }

    .filter-section {
      background: white;
      padding: 24px 32px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      margin-bottom: 24px;
      display: flex;
      gap: 20px;
      align-items: end;
    }

    .filter-group {
      flex: 1;
      position: relative;
    }

    .filter-label {
      display: block;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 10px;
    }

    .filter-select {
      width: 100%;
      padding: 11px 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.94rem;
      font-family: inherit;
      color: var(--text-primary);
      transition: all 0.2s ease;
      background: var(--bg-secondary);
    }

    .filter-select:focus {
      outline: none;
      border-color: var(--secondary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      background: white;
    }

    .filter-option {
      padding: 12px 14px;
      cursor: pointer;
      border-bottom: 1px solid var(--border-light);
      transition: all 0.2s ease;
    }

    .filter-option:hover {
      background: var(--bg);
    }

    .filter-option-name {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 2px;
    }

    .filter-option-code {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .card {
      background: white;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
    }

    .card-header {
      padding: 24px 32px;
      border-bottom: 1px solid var(--border-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(to bottom, #fafbfc 0%, #ffffff 100%);
    }

    .card-title {
      font-size: 1.15rem;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -0.01em;
    }

    .stats-badge {
      background: var(--bg);
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-secondary);
    }

    /* FIXED TABLE STYLES - PREVENTS COLUMN OVERFLOW */
    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      /* Forces fixed column widths */
    }

    thead {
      border-bottom: 2px solid var(--border);
    }

    tbody tr {
      border-bottom: 1px solid var(--border-light);
    }

    th {
      background: #fafbfc;
      padding: 18px 16px;
      text-align: center;
      font-weight: 700;
      color: var(--text-secondary);
      font-size: 0.82rem;
      text-transform: uppercase;
      border-bottom: none;
    }

    /* Set explicit column widths for intent-policies */
    th:nth-child(1) {
      width: 14%;
    }

    /* Intent */
    th:nth-child(2) {
      width: 10%;
    }

    /* Language */
    th:nth-child(3) {
      width: 9%;
    }

    /* Auto Process % */
    th:nth-child(4) {
      width: 9%;
    }

    /* Manual Review % */
    th:nth-child(5) {
      width: 15%;
    }

    /* Multi-Intent Mode */
    th:nth-child(6) {
      width: 10%;
    }

    /* Allow Multi Auto */
    th:nth-child(7) {
      width: 10%;
    }

    /* Allow Subset Auto */
    th:nth-child(8) {
      width: 23%;
      padding-right: 32px !important;
    }

    /* Actions */

    td {
      padding: 28px 16px;
      border-bottom: none;
      font-size: 0.94rem;
      text-align: center;
      /* Enable text wrapping */
      word-wrap: break-word;
      overflow-wrap: break-word;
      hyphens: auto;
      /* Vertically center content */
      vertical-align: middle;
    }

    /* Add extra padding to Actions column cells */
    td:nth-child(8) {
      padding-right: 32px !important;
    }

    tr:hover {
      background: #f8fafc;
      box-shadow: inset 3px 0 0 var(--secondary);
    }

    .intent-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 600;
      background: rgba(59, 130, 246, 0.1);
      color: var(--secondary);
      white-space: normal;
      word-break: break-word;
    }

    .language-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 600;
      background: rgba(139, 92, 246, 0.1);
      color: var(--accent);
    }

    .confidence-value {
      font-weight: 600;
      color: var(--text-primary);
      font-family: "Courier New", monospace;
    }

    .mode-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 600;
      white-space: normal;
      word-break: break-word;
    }

    .mode-strict {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
    }

    .mode-auto-all {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
    }

    .mode-auto-subset {
      background: rgba(245, 158, 11, 0.1);
      color: var(--warning);
    }

    .boolean-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .boolean-true {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
    }

    .boolean-false {
      background: rgba(148, 163, 184, 0.15);
      color: var(--text-secondary);
    }

    .actions {
      display: inline-flex;
      gap: 4px;
      justify-content: center;
      /* Keep all buttons in one line */
      flex-wrap: nowrap;
      /* Vertically center the buttons */
      align-items: center;
      /* Add margin to prevent touching borders */
      margin: 6px 0;
    }

    .action-btn {
      padding: 6px 10px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      transition: all 0.2s ease;
      background: white;
      color: var(--text-secondary);
      font-size: 0.8rem;
      font-weight: 600;
      /* Prevent buttons from wrapping text */
      white-space: nowrap;
      /* Prevent button from shrinking */
      flex-shrink: 0;
      line-height: 1;
    }

    .action-btn i {
      font-size: 0.8rem;
      margin-right: 4px;
    }

    .action-btn:hover {
      background: var(--secondary);
      color: white;
      border-color: var(--secondary);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(59, 130, 246, 0.25);
    }

    .action-btn.delete:hover {
      background: var(--danger);
      border-color: var(--danger);
      box-shadow: 0 4px 8px rgba(239, 68, 68, 0.25);
    }

    /* STANDARDIZED MODAL STYLES - FIXED VERSION */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(4px);
      display: none;
      justify-content: center;
      align-items: center;
      padding: 20px;
      z-index: 1000;
      animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 0;
      border-radius: var(--radius-lg);
      width: 100%;
      max-width: 600px;
      box-shadow: var(--shadow-lg);
      animation: slideUp 0.3s ease;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 2px solid var(--border-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(to bottom, #fafbfc 0%, #ffffff 100%);
      flex-shrink: 0;
    }

    .modal-header h3 {
      font-size: 1.35rem;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -0.01em;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .modal-header h3 i {
      width: 40px;
      height: 40px;
      background: rgba(59, 130, 246, 0.1);
      color: var(--secondary);
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
    }

    .close-btn {
      width: 36px;
      height: 36px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: white;
      color: var(--text-secondary);
      font-size: 1.3rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .close-btn:hover {
      background: var(--danger);
      color: white;
      border-color: var(--danger);
    }

    .modal-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .form-input,
    .form-textarea,
    select.form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.9rem;
      font-family: inherit;
      color: var(--text-primary);
      transition: all 0.2s ease;
      background: var(--bg-secondary);
    }

    .form-input:focus,
    .form-textarea:focus,
    select.form-input:focus {
      outline: none;
      border-color: var(--secondary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      background: white;
    }

    .form-textarea {
      resize: vertical;
      min-height: 80px;
    }

    select.form-input {
      cursor: pointer;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background: var(--bg);
      border-radius: var(--radius);
      border: 1px solid var(--border-light);
    }

    .checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--secondary);
    }

    .checkbox-group label {
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-primary);
      cursor: pointer;
      user-select: none;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 2px solid var(--border-light);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      background: var(--bg);
      flex-shrink: 0;
    }

    .btn {
      padding: 10px 18px;
      border-radius: var(--radius);
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.875rem;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg,
          var(--secondary) 0%,
          var(--secondary-dark) 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.25);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.35);
    }

    .btn-secondary {
      background: white;
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--bg);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.25);
    }

    .btn-danger:hover {
      background: #dc2626;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.35);
    }

    .delete-modal-content {
      max-width: 480px;
    }

    .modal-icon {
      width: 64px;
      height: 64px;
      background: rgba(239, 68, 68, 0.1);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
    }

    .modal-icon i {
      font-size: 1.8rem;
      color: var(--danger);
    }

    .modal-title {
      font-size: 1.35rem;
      font-weight: 700;
      margin-bottom: 12px;
      color: var(--text-primary);
      letter-spacing: -0.01em;
      text-align: center;
    }

    .modal-text {
      color: var(--text-secondary);
      font-size: 0.95rem;
      margin-bottom: 24px;
      line-height: 1.6;
      text-align: center;
    }

    .empty-state {
      padding: 80px 20px;
      text-align: center;
      color: var(--text-secondary);
    }

    .empty-icon {
      width: 120px;
      height: 120px;
      background: linear-gradient(135deg,
          rgba(59, 130, 246, 0.08) 0%,
          rgba(139, 92, 246, 0.08) 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
    }

    .empty-icon i {
      font-size: 3.5rem;
      color: var(--secondary);
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 10px;
      color: var(--text-primary);
    }

    .empty-state p {
      font-size: 0.95rem;
      color: var(--text-tertiary);
    }

    .loading {
      padding: 60px;
      text-align: center;
      color: var(--text-secondary);
    }

    .loading i {
      font-size: 2rem;
      margin-bottom: 16px;
      color: var(--secondary);
    }

    .loading-text {
      font-size: 0.95rem;
      font-weight: 500;
    }

    .error-state {
      padding: 60px 20px;
      text-align: center;
    }

    .error-icon {
      width: 100px;
      height: 100px;
      background: rgba(239, 68, 68, 0.1);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
    }

    .error-icon i {
      font-size: 2.5rem;
      color: var(--danger);
    }

    .error-state h3 {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 10px;
      color: var(--text-primary);
    }

    .error-state p {
      font-size: 0.95rem;
      color: var(--text-secondary);
      margin-bottom: 20px;
    }

    /* NOTIFICATION POPUP */
    .notification-popup {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 23, 42, 0.5);
      backdrop-filter: blur(8px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 3000;
      animation: fadeIn 0.2s ease;
    }

    .notification-popup.active {
      display: flex;
    }

    .notification-content {
      background: white;
      border-radius: var(--radius-lg);
      box-shadow: 0 20px 60px rgba(15, 23, 42, 0.3);
      max-width: 500px;
      width: 90%;
      padding: 0;
      animation: slideUpBounce 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      display: flex;
      gap: 20px;
      position: relative;
      overflow: hidden;
    }

    @keyframes slideUpBounce {
      0% {
        opacity: 0;
        transform: translateY(50px) scale(0.9);
      }

      100% {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .notification-icon {
      background: linear-gradient(135deg,
          var(--secondary) 0%,
          var(--secondary-dark) 100%);
      padding: 32px 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .notification-icon i {
      font-size: 2.5rem;
      color: white;
    }

    .notification-body {
      padding: 28px 20px 28px 0;
      flex: 1;
    }

    .notification-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 10px;
      letter-spacing: -0.01em;
    }

    .notification-message {
      font-size: 0.95rem;
      color: var(--text-secondary);
      line-height: 1.6;
      margin-bottom: 0;
    }

    .notification-link-container {
      margin-top: 18px;
      padding-top: 18px;
      border-top: 1px solid var(--border-light);
    }

    .notification-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      background: linear-gradient(135deg,
          var(--secondary) 0%,
          var(--secondary-dark) 100%);
      color: white;
      text-decoration: none;
      border-radius: var(--radius);
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.25);
    }

    .notification-link:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.35);
      gap: 12px;
    }

    .notification-close {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 32px;
      height: 32px;
      border: none;
      background: rgba(15, 23, 42, 0.05);
      color: var(--text-secondary);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      transition: all 0.2s ease;
    }

    .notification-close:hover {
      background: var(--danger);
      color: white;
      transform: rotate(90deg);
    }

    @media (max-width: 640px) {
      .notification-content {
        flex-direction: column;
        max-width: 95%;
      }

      .notification-icon {
        padding: 24px;
      }

      .notification-body {
        padding: 20px;
      }
    }

    #cancel:hover {
      background: var(--danger);
      color: white;
      border-color: var(--danger);
    }

    /* EXPANDABLE POLICY ROW */
    .expanded-row {
      display: none;
    }

    .expanded-row.show {
      display: table-row;
    }

    .expanded-content {
      padding: 22px 28px;
      background: #f8fafc;
      border-top: 2px solid var(--border);
    }

    .expanded-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 18px 28px;
    }

    .expanded-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .expanded-field-label {
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--text-secondary);
      text-transform: uppercase;
    }

    .expanded-field-value {
      font-size: 0.92rem;
      font-weight: 600;
      background: white;
      padding: 10px 12px;
      border-radius: var(--radius);
      border: 1px solid var(--border-light);
    }

    .expanded-field-value.null {
      color: var(--text-tertiary);
      font-style: italic;
    }

    /* Ultra-compact row hint */
    .table-note {
      margin: 6px 24px;
      /* very small vertical space */
      padding: 4px 8px;

      font-size: 0.78rem;
      font-weight: 500;
      color: var(--text-tertiary);

      background: transparent;
      /* no box */
      border-left: 2px solid var(--secondary);
      border-radius: 0;
    }
  </style>
  <link rel="stylesheet" href="responsive.css" />
</head>

<body>
  <aside class="sidebar">
    <div class="logo">
      <i class="fas fa-shield-alt"></i><span>FlowEngine</span>
    </div>
    <nav class="nav-menu">
      <a href="index.html" class="nav-link"><i class="fas fa-home"></i>Dashboard</a>
      <a href="datasources.html" class="nav-link"><i class="fas fa-database"></i>Datasources</a>
      <a href="datasource-configs.html" class="nav-link"><i class="fas fa-cog"></i>Datasource Configs</a>
      <a href="intents.html" class="nav-link"><i class="fas fa-bullseye"></i>Intents</a>
      <a href="intent-policies.html" class="nav-link active"><i class="fas fa-sliders-h"></i>Intent Policies</a>
      <a href="rules.html" class="nav-link"><i class="fas fa-check-double"></i>Validation Rules</a>
    </nav>
  </aside>
  <main class="main-content">
    <div class="topbar">
      <h1 class="topbar-title">
        <i class="fas fa-sliders-h"></i>Intent Policies
      </h1>
      <button class="add-btn" id="addPolicyBtn" onclick="openAddModal()">
        <i class="fas fa-plus-circle"></i>Add Policy
      </button>
    </div>
    <div class="content-area">
      <div class="filter-section">
        <div class="filter-group">
          <label class="filter-label">Search Intent</label>
          <input type="text" class="filter-select" id="intentFilterSearch"
            placeholder="Type to search intents or type 'all' for all policies..." autocomplete="off"
            style="cursor: text" />
          <div id="intentFilterDropdown" style="position: relative; display: none; margin-top: 8px">
            <div id="intentFilterList" style="
                  position: absolute;
                  top: 0;
                  left: 0;
                  right: 0;
                  background: white;
                  border: 1px solid var(--border);
                  border-radius: var(--radius);
                  max-height: 200px;
                  overflow-y: auto;
                  box-shadow: var(--shadow-lg);
                  z-index: 1000;
                "></div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">Policy Configuration</div>
          <div class="stats-badge" id="statsBadge">0 policies</div>
        </div>
        <div class="table-note">
          Click a row to view full intent-policy details
        </div>

        <div id="loadingState" class="loading" style="display: none">
          <i class="fas fa-spinner fa-spin"></i>
          <div class="loading-text">Loading policies...</div>
        </div>
        <div id="errorState" class="error-state" style="display: none">
          <div class="error-icon">
            <i class="fas fa-exclamation-triangle"></i>
          </div>
          <h3>Error Loading Policies</h3>
          <p id="errorMessage">Something went wrong. Please try again.</p>
          <button class="btn btn-primary" onclick="loadAllPolicies()">
            <i class="fas fa-redo"></i>Retry
          </button>
        </div>
        <table id="policyTable">
          <thead>
            <tr>
              <th>Intent</th>
              <th>Language</th>
              <th>Auto Process (%)</th>
              <th>Manual Review (%)</th>
              <th>Actions</th>
            </tr>
          </thead>

          <tbody id="policyRows"></tbody>
        </table>
        <div id="emptyState" class="empty-state" style="display: none">
          <div class="empty-icon"><i class="fas fa-sliders-h"></i></div>
          <h3>No Policies Found</h3>
          <p>Add policies to configure intent processing rules.</p>
        </div>
      </div>

    </div>
  </main>
  <div class="modal" id="policyModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">
          <i class="fas fa-sliders-h"></i><span id="modalTitleText">Add Policy</span>
        </h3>
        <button class="close-btn" onclick="closePolicyModal()">×</button>
      </div>
      <div class="modal-body">
        <div class="form-group" id="intentSearchGroup">
          <label class="form-label">Select Intent *</label>
          <input class="form-input" id="intentSearch" placeholder="Type to search intents without policies..."
            autocomplete="off" />
          <div id="intentDropdown" style="position: relative; display: none">
            <div id="intentList" style="
                  position: absolute;
                  top: 0;
                  left: 0;
                  right: 0;
                  background: white;
                  border: 1px solid var(--border);
                  border-radius: var(--radius);
                  max-height: 200px;
                  overflow-y: auto;
                  box-shadow: var(--shadow-lg);
                  z-index: 1000;
                "></div>
          </div>
          <input type="hidden" id="selectedIntentId" />
        </div>

        <div class="form-group">
          <label class="form-label">Language Code</label>
          <select class="form-input" id="language_code">
            <option value="multi">Multi (Default)</option>
            <option value="en">English</option>
            <option value="hi">Hindi</option>
            <option value="es">Spanish</option>
            <option value="fr">French</option>
            <option value="de">German</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">N8N Orchestration URL (Optional)</label>
          <input class="form-input" type="url" id="n8n_orchestration_url"
            placeholder="https://n8n.example.com/webhook/..." />
        </div>
        <div class="form-group">
          <label class="form-label">Auto Process Min Confidence (%)</label>
          <input class="form-input" type="number" id="auto_process_min_conf" min="0" max="100" step="0.01"
            placeholder="90.00" />
        </div>
        <div class="form-group">
          <label class="form-label">Manual Review Min Confidence (%)</label>
          <input class="form-input" type="number" id="manual_review_min_conf" min="0" max="100" step="0.01"
            placeholder="80.00" />
        </div>
        <div class="form-group">
          <label class="form-label">Reroute Email (Optional)</label>
          <input class="form-input" type="email" id="reroute_email" placeholder="example@domain.com" />
        </div>
        <div class="form-group">
          <label class="form-label">Multi-Intent Mode</label>
          <select class="form-input" id="multi_intent_mode">
            <option value="STRICT_SINGLE">Strict Single</option>
            <option value="AUTO_ALL">Auto All</option>
            <option value="AUTO_SUBSET">Auto Subset</option>
          </select>
        </div>

        <div class="form-group">
          <div class="checkbox-group">
            <input type="checkbox" id="allow_multi_auto" />
            <label for="allow_multi_auto">Allow Multi Auto</label>
          </div>
        </div>
        <div class="form-group">
          <div class="checkbox-group">
            <input type="checkbox" id="allow_subset_auto" />
            <label for="allow_subset_auto">Allow Subset Auto</label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closePolicyModal()" id="cancel">
          <i class="fas fa-times"></i>Cancel
        </button>
        <button class="btn btn-primary" onclick="savePolicy()">
          <i class="fas fa-check"></i>Save Policy
        </button>
      </div>
    </div>
  </div>
  <div class="modal" id="deleteModal">
    <div class="modal-content delete-modal-content">
      <div class="modal-body" style="padding: 32px 24px; text-align: center">
        <div class="modal-icon">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h3 class="modal-title">Delete Policy</h3>
        <p class="modal-text">
          Are you sure you want to delete this policy? This action cannot be
          undone.
        </p>
        <input type="hidden" id="deleteIntentId" />
        <input type="hidden" id="deleteLanguageCode" />
      </div>
      <div class="modal-footer" style="border-top: none; justify-content: center">
        <button class="btn btn-secondary" onclick="closeDeleteModal()" id="cancel">
          Cancel
        </button>
        <button class="btn btn-danger" onclick="confirmDelete()">
          <i class="fas fa-trash"></i>Delete Policy
        </button>
      </div>
    </div>
  </div>

  <!-- NOTIFICATION POPUP -->
  <div class="notification-popup" id="notificationPopup">
    <div class="notification-content">
      <div class="notification-icon" id="notificationIcon">
        <i class="fas fa-info-circle" id="notificationIconEl"></i>
      </div>
      <div class="notification-body">
        <h4 class="notification-title" id="notificationTitle">Information</h4>
        <p class="notification-message" id="notificationMessage">
          This is a notification message.
        </p>
        <div class="notification-link-container" id="notificationLinkContainer" style="display: none">
          <a href="#" class="notification-link" id="notificationLink">
            <span id="notificationLinkText">Visit page</span>
            <i class="fas fa-arrow-right"></i>
          </a>
        </div>
      </div>
      <button class="notification-close" onclick="closeNotification()">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>

  <script>
    const API = window.location.origin;

    // Check tenant session
    const tenantId = sessionStorage.getItem("tenant_id");
    if (!tenantId) {
      window.location.href = "tenant-login.html";
    }
    let allPolicies = [];
    let allIntents = [];
    let intentsWithoutPolicies = [];
    let selectedIntentFilter = null; // null = All, number = specific intent_id
    let editIntentId = null;
    let editLanguageCode = null;

    // Check for URL parameters (when navigating from intents.html)
    const urlParams = new URLSearchParams(window.location.search);
    const urlIntentId = urlParams.get("intent_id");

    // ==================== NOTIFICATION FUNCTIONS ====================
    function showNotification(
      title,
      message,
      type = "info",
      linkText = null,
      linkUrl = null,
    ) {
      document.getElementById("notificationTitle").textContent = title;
      document.getElementById("notificationMessage").textContent = message;

      const icon = document.getElementById("notificationIcon");
      const iconEl = document.getElementById("notificationIconEl");

      switch (type) {
        case "success":
          icon.style.background =
            "linear-gradient(135deg, var(--success) 0%, #059669 100%)";
          iconEl.className = "fas fa-check-circle";
          break;
        case "error":
          icon.style.background =
            "linear-gradient(135deg, var(--danger) 0%, #DC2626 100%)";
          iconEl.className = "fas fa-exclamation-circle";
          break;
        case "warning":
          icon.style.background =
            "linear-gradient(135deg, var(--warning) 0%, var(--warning-dark) 100%)";
          iconEl.className = "fas fa-exclamation-triangle";
          break;
        default:
          icon.style.background =
            "linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%)";
          iconEl.className = "fas fa-info-circle";
      }

      const linkContainer = document.getElementById(
        "notificationLinkContainer",
      );
      const link = document.getElementById("notificationLink");
      const linkTextEl = document.getElementById("notificationLinkText");

      if (linkText && linkUrl) {
        linkTextEl.textContent = linkText;
        link.href = linkUrl;
        linkContainer.style.display = "block";
      } else {
        linkContainer.style.display = "none";
      }

      document.getElementById("notificationPopup").classList.add("active");

      if (!linkText && !linkUrl) {
        setTimeout(() => closeNotification(), 6000);
      }
    }

    function closeNotification() {
      document.getElementById("notificationPopup").classList.remove("active");
    }

    document.addEventListener("DOMContentLoaded", function () {
      document
        .getElementById("notificationPopup")
        .addEventListener("click", function (e) {
          if (e.target === this) closeNotification();
        });
    });

    async function loadIntents() {
      try {
        const res = await fetch(`${API}/intents`, {
          headers: { "X-Tenant-ID": tenantId },
        });
        if (!res.ok) throw new Error("Failed to load intents");
        allIntents = await res.json();

        // If coming from intents.html, pre-select the intent
        if (urlIntentId) {
          const intent = allIntents.find((i) => i.intent_id == urlIntentId);
          if (intent) {
            selectedIntentFilter = parseInt(urlIntentId);
            document.getElementById("intentFilterSearch").value =
              intent.display_name;
          }
        }
      } catch (err) {
        console.error("Failed to load intents:", err);
        showError("Failed to load intents. Please refresh the page.");
      }
    }

    async function loadIntentsWithoutPolicies() {
      try {
        // Get policy keys (intent_id + language_code combinations)
        const policyKeys = allPolicies.map(
          (p) => `${p.intent_id}_${p.language_code}`,
        );

        // Filter intents that don't have policies for language 'multi'
        intentsWithoutPolicies = allIntents.filter(
          (intent) => !policyKeys.includes(`${intent.intent_id}_multi`),
        );
      } catch (err) {
        console.error("Failed to filter intents:", err);
      }
    }

    // Type-ahead search for filter
    document.addEventListener("DOMContentLoaded", function () {
      const filterSearchInput = document.getElementById("intentFilterSearch");
      const filterDropdown = document.getElementById("intentFilterDropdown");
      const filterDropdownList = document.getElementById("intentFilterList");

      filterSearchInput.addEventListener("input", function () {
        const searchTerm = this.value.toLowerCase().trim();

        if (!searchTerm) {
          filterDropdown.style.display = "none";
          selectedIntentFilter = null;
          renderPolicies();
          return;
        }

        // Check if searching for "all"
        const showAllOption =
          "all".includes(searchTerm) ||
          "all intents".includes(searchTerm) ||
          "all policies".includes(searchTerm);

        const filtered = allIntents.filter(
          (intent) =>
            intent.intent_code.toLowerCase().includes(searchTerm) ||
            intent.display_name.toLowerCase().includes(searchTerm),
        );

        if (!showAllOption && filtered.length === 0) {
          filterDropdownList.innerHTML =
            '<div style="padding: 10px 12px; color: var(--text-secondary); text-align: center;">No matching intents found</div>';
          filterDropdown.style.display = "block";
          return;
        }

        let html = "";

        // Add "All Intents" option if searching for "all"
        if (showAllOption) {
          html += `
						  <div class="filter-option" onclick="selectFilterIntent(null)">
							<div class="filter-option-name">All Intents</div>
							<div class="filter-option-code">View policies for all intents</div>
						  </div>
						`;
        }

        // Add filtered intents
        filtered.forEach((intent) => {
          html += `
						  <div class="filter-option" onclick="selectFilterIntent(${intent.intent_id})">
							<div class="filter-option-name">${escapeHtml(intent.display_name)}</div>
							<div class="filter-option-code">Code: ${escapeHtml(intent.intent_code)}</div>
						  </div>
						`;
        });

        filterDropdownList.innerHTML = html;
        filterDropdown.style.display = "block";
      });

      // Close dropdown when clicking outside
      document.addEventListener("click", function (e) {
        if (
          !filterSearchInput.contains(e.target) &&
          !filterDropdown.contains(e.target)
        ) {
          filterDropdown.style.display = "none";
        }
      });

      init();
    });

    function selectFilterIntent(intentId) {
      selectedIntentFilter = intentId;

      const searchInput = document.getElementById("intentFilterSearch");
      const dropdown = document.getElementById("intentFilterDropdown");

      // Fill search box with selected intent name
      if (intentId === null) {
        searchInput.value = "All Intents";
      } else {
        const intent = allIntents.find((i) => i.intent_id === intentId);
        if (intent) {
          searchInput.value = intent.display_name;
        }
      }

      // Hide the dropdown
      dropdown.style.display = "none";

      // Re-render policies with filter
      renderPolicies();
    }

    // Type-ahead search for Add/Edit modal
    document.addEventListener("DOMContentLoaded", function () {
      const searchInput = document.getElementById("intentSearch");
      const dropdown = document.getElementById("intentDropdown");
      const dropdownList = document.getElementById("intentList");

      searchInput.addEventListener("input", function () {
        const searchTerm = this.value.toLowerCase().trim();

        // Reset selection and visual feedback when typing
        document.getElementById("selectedIntentId").value = "";
        searchInput.style.borderColor = "";
        searchInput.style.background = "";

        if (!searchTerm) {
          dropdown.style.display = "none";
          return;
        }

        const filtered = intentsWithoutPolicies.filter(
          (intent) =>
            intent.intent_code.toLowerCase().includes(searchTerm) ||
            intent.display_name.toLowerCase().includes(searchTerm),
        );

        if (filtered.length === 0) {
          dropdownList.innerHTML =
            '<div style="padding: 10px 12px; color: var(--text-secondary); text-align: center;">No intents without policies found</div>';
          dropdown.style.display = "block";
          return;
        }

        dropdownList.innerHTML = filtered
          .map(
            (intent) => `
						<div onclick="selectIntent(${intent.intent_id})" style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid var(--border-light); transition: background 0.2s;" onmouseover="this.style.background='var(--bg)'" onmouseout="this.style.background='white'">
						  <div style="font-weight: 600; color: var(--text-primary);">${escapeHtml(intent.display_name)}</div>
						  <div style="font-size: 0.85rem; color: var(--text-secondary);">Code: ${escapeHtml(intent.intent_code)}</div>
						</div>
					  `,
          )
          .join("");

        dropdown.style.display = "block";
      });

      // Close dropdown when clicking outside
      document.addEventListener("click", function (e) {
        if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
          dropdown.style.display = "none";
        }
      });
    });

    function selectIntent(intentId) {
      const intent = intentsWithoutPolicies.find(
        (i) => i.intent_id === intentId,
      );
      if (!intent) return;

      // Set values
      document.getElementById("intentSearch").value = intent.display_name;
      document.getElementById("selectedIntentId").value = intent.intent_id;

      // Add visual feedback
      document.getElementById("intentSearch").style.borderColor =
        "var(--success)";
      document.getElementById("intentSearch").style.background =
        "rgba(16, 185, 129, 0.05)";

      document.getElementById("intentDropdown").style.display = "none";
    }

    async function loadAllPolicies() {
      try {
        hideError();
        showLoading();

        const res = await fetch(`${API}/intents/policies/all`, {
          headers: { "X-Tenant-ID": tenantId },
        });
        if (!res.ok) throw new Error("Failed to load policies");

        allPolicies = await res.json();
        hideLoading();
        renderPolicies();
      } catch (err) {
        console.error("Failed to load policies:", err);
        hideLoading();
        showError(
          "Failed to load policies. Please check your connection and try again.",
        );
      }
    }

    function showLoading() {
      document.getElementById("loadingState").style.display = "block";
      document.getElementById("policyTable").style.display = "none";
      document.getElementById("emptyState").style.display = "none";
      document.getElementById("errorState").style.display = "none";
    }

    function hideLoading() {
      document.getElementById("loadingState").style.display = "none";
    }

    function showError(message) {
      document.getElementById("errorMessage").textContent = message;
      document.getElementById("errorState").style.display = "block";
      document.getElementById("policyTable").style.display = "none";
      document.getElementById("emptyState").style.display = "none";
      document.getElementById("loadingState").style.display = "none";
    }

    function hideError() {
      document.getElementById("errorState").style.display = "none";
    }
    function renderPolicies() {
      let filteredPolicies = allPolicies;

      if (selectedIntentFilter !== null) {
        filteredPolicies = allPolicies.filter(
          p => p.intent_id == selectedIntentFilter
        );
      }

      updateStatsBadge(filteredPolicies.length);

      if (!filteredPolicies.length) {
        document.getElementById("emptyState").style.display = "block";
        document.getElementById("policyTable").style.display = "none";
        return;
      }

      document.getElementById("emptyState").style.display = "none";
      document.getElementById("policyTable").style.display = "table";

      const tbody = document.getElementById("policyRows");
      tbody.innerHTML = "";

      filteredPolicies.forEach(p => {
        const key = `${p.intent_id}_${p.language_code}`;

        tbody.innerHTML += `
      <!-- COLLAPSED ROW (UNCHANGED) -->
      <tr onclick="toggleExpandPolicy('${key}', event)">
        <td>
          <span class="intent-badge">
            <i class="fas fa-bullseye"></i>
            ${escapeHtml(p.intent_code)}
          </span>
        </td>

        <td>
          <span class="language-badge">
            <i class="fas fa-language"></i>
            ${escapeHtml(p.language_code.toUpperCase())}
          </span>
        </td>

        <td>
          <span class="confidence-value">${p.auto_process_min_conf}%</span>
        </td>

        <td>
          <span class="confidence-value">${p.manual_review_min_conf}%</span>
        </td>

        <td>
          <div class="actions">
            <button class="action-btn"
              onclick="openEditModal(${p.intent_id}, '${p.language_code}')">
              <i class="fas fa-pen"></i> Edit
            </button>
            <button class="action-btn delete"
              onclick="openDeleteModal(${p.intent_id}, '${p.language_code}')">
              <i class="fas fa-trash"></i> Delete
            </button>
          </div>
        </td>
      </tr>

      <!-- EXPANDED ROW (ONLY REQUESTED FIELDS) -->
      <tr class="expanded-row" id="expanded-policy-${key}">
        <td colspan="5">
          <div class="expanded-content">
            <div class="expanded-grid">

              <div class="expanded-field">
                <div class="expanded-field-label">Intent ID</div>
                <div class="expanded-field-value">${fmt(p.intent_id)}</div>
              </div>

              <div class="expanded-field">
                <div class="expanded-field-label">Language Code</div>
                <div class="expanded-field-value">${fmt(p.language_code)}</div>
              </div>

              <div class="expanded-field">
                <div class="expanded-field-label">Auto Process Min Confidence (%)</div>
                <div class="expanded-field-value">${fmt(p.auto_process_min_conf)}</div>
              </div>

              <div class="expanded-field">
                <div class="expanded-field-label">Manual Review Min Confidence (%)</div>
                <div class="expanded-field-value">${fmt(p.manual_review_min_conf)}</div>
              </div>

              <div class="expanded-field">
                <div class="expanded-field-label">Multi Intent Mode</div>
                <div class="expanded-field-value">${fmt(p.multi_intent_mode)}</div>
              </div>

              <div class="expanded-field">
                <div class="expanded-field-label">Allow Multi Auto</div>
                <div class="expanded-field-value">${fmt(p.allow_multi_auto)}</div>
              </div>

              <div class="expanded-field">
                <div class="expanded-field-label">Allow Subset Auto</div>
                <div class="expanded-field-value">${fmt(p.allow_subset_auto)}</div>
              </div>

              <div class="expanded-field">
                <div class="expanded-field-label">N8N Orchestration URL</div>
                <div class="expanded-field-value">${fmt(p.n8n_orchestration_url)}</div>
              </div>

              <div class="expanded-field">
                <div class="expanded-field-label">Reroute Email</div>
                <div class="expanded-field-value">${fmt(p.reroute_email)}</div>
              </div>

            </div>
          </div>
        </td>
      </tr>
    `;
      });
    }

    function updateStatsBadge(count) {
      const badge = document.getElementById("statsBadge");
      badge.textContent = `${count} ${count === 1 ? "policy" : "policies"}`;
    }

    function escapeHtml(text) {
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }

    async function openAddModal() {
      editIntentId = null;
      editLanguageCode = null;
      document.getElementById("modalTitleText").innerText = "Add Policy";

      document.getElementById("language_code").value = "multi";
      document.getElementById("n8n_orchestration_url").value = "";
      document.getElementById("auto_process_min_conf").value = "";
      document.getElementById("manual_review_min_conf").value = "";
      document.getElementById("reroute_email").value = "";
      document.getElementById("multi_intent_mode").value = "STRICT_SINGLE";
      document.getElementById("allow_multi_auto").checked = false;
      document.getElementById("allow_subset_auto").checked = false;

      // Show and reset intent search
      document.getElementById("intentSearchGroup").style.display = "block";
      document.getElementById("intentSearch").value = "";
      document.getElementById("selectedIntentId").value = "";
      document.getElementById("intentSearch").style.borderColor = "";
      document.getElementById("intentSearch").style.background = "";

      // Pre-select intent if filtered
      if (selectedIntentFilter !== null) {
        const intent = allIntents.find(
          (i) => i.intent_id == selectedIntentFilter,
        );
        if (intent) {
          document.getElementById("intentSearch").value = intent.display_name;
          document.getElementById("selectedIntentId").value =
            intent.intent_id;
          document.getElementById("intentSearch").style.borderColor =
            "var(--success)";
          document.getElementById("intentSearch").style.background =
            "rgba(16, 185, 129, 0.05)";
        }
      }

      // Load intents without policies
      await loadIntentsWithoutPolicies();

      document.getElementById("policyModal").classList.add("active");
    }

    async function openEditModal(intentId, languageCode) {
      editIntentId = intentId;
      editLanguageCode = languageCode;
      document.getElementById("modalTitleText").innerText = "Edit Policy";

      // Hide intent search when editing
      document.getElementById("intentSearchGroup").style.display = "none";

      try {
        const res = await fetch(
          `${API}/intents/${intentId}/policies/${languageCode}`,
          {
            headers: { "X-Tenant-ID": tenantId },
          },
        );
        if (!res.ok) throw new Error("Failed to load policy");
        const data = await res.json();

        document.getElementById("language_code").value = data.language_code;
        document.getElementById("n8n_orchestration_url").value =
          data.n8n_orchestration_url || "";
        document.getElementById("auto_process_min_conf").value =
          data.auto_process_min_conf;
        document.getElementById("manual_review_min_conf").value =
          data.manual_review_min_conf;
        document.getElementById("reroute_email").value =
          data.reroute_email || "";
        document.getElementById("multi_intent_mode").value =
          data.multi_intent_mode;
        document.getElementById("allow_multi_auto").checked =
          data.allow_multi_auto;
        document.getElementById("allow_subset_auto").checked =
          data.allow_subset_auto;

        document.getElementById("policyModal").classList.add("active");
      } catch (err) {
        console.error("Failed to load policy:", err);
        showNotification(
          "Failed to Load Policy",
          "An error occurred while loading the policy details. Please try again.",
          "error",
        );
      }
    }

    function closePolicyModal() {
      document.getElementById("policyModal").classList.remove("active");
    }

    async function savePolicy() {
      // CRITICAL VALIDATION: If adding new policy (not editing), must select valid intent
      if (!editIntentId) {
        const selectedIntentId =
          document.getElementById("selectedIntentId").value;
        if (!selectedIntentId) {
          showNotification(
            "Intent Required",
            "Please select a valid intent from the dropdown list before saving.",
            "warning",
          );
          document.getElementById("intentSearch").focus();
          return;
        }
      }

      const intentId =
        editIntentId || document.getElementById("selectedIntentId").value;

      if (!intentId) {
        showNotification(
          "Intent Required",
          "Please select an intent before saving the policy.",
          "warning",
        );
        return;
      }

      // Validate required fields
      const autoProcessConf = document.getElementById(
        "auto_process_min_conf",
      ).value;
      const manualReviewConf = document.getElementById(
        "manual_review_min_conf",
      ).value;

      if (!autoProcessConf || autoProcessConf === "") {
        showNotification(
          "Auto Process Confidence Required",
          "Please enter the auto process minimum confidence percentage.",
          "warning",
        );
        document.getElementById("auto_process_min_conf").focus();
        return;
      }

      if (!manualReviewConf || manualReviewConf === "") {
        showNotification(
          "Manual Review Confidence Required",
          "Please enter the manual review minimum confidence percentage.",
          "warning",
        );
        document.getElementById("manual_review_min_conf").focus();
        return;
      }

      const payload = {
        language_code: document.getElementById("language_code").value,
        n8n_orchestration_url:
          document.getElementById("n8n_orchestration_url").value.trim() ||
          null,
        auto_process_min_conf: parseFloat(autoProcessConf),
        manual_review_min_conf: parseFloat(manualReviewConf),
        reroute_email:
          document.getElementById("reroute_email").value.trim() || null,
        multi_intent_mode: document.getElementById("multi_intent_mode").value,
        allow_multi_auto: document.getElementById("allow_multi_auto").checked,
        allow_subset_auto:
          document.getElementById("allow_subset_auto").checked,
      };

      try {
        const url = editLanguageCode
          ? `${API}/intents/${intentId}/policies/${editLanguageCode}`
          : `${API}/intents/${intentId}/policies`;
        const method = editLanguageCode ? "PUT" : "POST";

        const res = await fetch(url, {
          method,
          headers: {
            "Content-Type": "application/json",
            "X-Tenant-ID": tenantId,
          },
          body: JSON.stringify(payload),
        });

        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.detail || "Failed to save policy");
        }

        closePolicyModal();
        showNotification(
          "Policy Saved Successfully",
          `The intent policy has been ${editLanguageCode ? "updated" : "created"} successfully.`,
          "success",
        );
        await loadAllPolicies();
      } catch (err) {
        console.error("Failed to save policy:", err);
        showNotification(
          "Failed to Save Policy",
          err.message ||
          "An error occurred while saving the policy. Please try again.",
          "error",
        );
      }
    }

    function openDeleteModal(intentId, languageCode) {
      document.getElementById("deleteIntentId").value = intentId;
      document.getElementById("deleteLanguageCode").value = languageCode;
      document.getElementById("deleteModal").classList.add("active");
    }

    function closeDeleteModal() {
      document.getElementById("deleteModal").classList.remove("active");
    }

    async function confirmDelete() {
      const intentId = document.getElementById("deleteIntentId").value;
      const languageCode =
        document.getElementById("deleteLanguageCode").value;
      if (!intentId || !languageCode) return;

      try {
        const res = await fetch(
          `${API}/intents/${intentId}/policies/${languageCode}`,
          {
            method: "DELETE",
            headers: { "X-Tenant-ID": tenantId },
          },
        );

        if (!res.ok) {
          throw new Error("Failed to delete policy");
        }

        closeDeleteModal();
        showNotification(
          "Policy Deleted",
          "The intent policy has been deleted successfully.",
          "success",
        );
        await loadAllPolicies();
      } catch (err) {
        console.error("Failed to delete policy:", err);
        showNotification(
          "Failed to Delete Policy",
          "An error occurred while deleting the policy. Please try again.",
          "error",
        );
        closeDeleteModal();
      }
    }

    document.getElementById("policyModal").addEventListener("click", (e) => {
      if (e.target === e.currentTarget) closePolicyModal();
    });

    document.getElementById("deleteModal").addEventListener("click", (e) => {
      if (e.target === e.currentTarget) closeDeleteModal();
    });

    // Initialize
    async function init() {
      await loadIntents();
      await loadAllPolicies();
    }
    function toggleExpandPolicy(key, event) {
      if (
        event &&
        (event.target.closest(".action-btn") ||
          event.target.closest(".actions"))
      ) {
        return;
      }

      const row = document.getElementById(`expanded-policy-${key}`);
      if (row) row.classList.toggle("show");
    }

    function fmt(value) {
      if (value === null || value === undefined || value === "") {
        return '<span class="null">Not set</span>';
      }
      if (typeof value === "boolean") {
        return value ? "Yes" : "No";
      }
      return escapeHtml(String(value));
    }
  </script>
  <script src="responsive.js"></script>
</body>

</html>